@page "/dm"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject ISusurriDbContext Context
@inject IOptions<AuthOptions> Options
@inject ITokenStorage TokenStorage
@using Susurri.Core.Abstractions
@using Susurri.Core.Entities
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Options
@using Susurri.Application.Abstractions
@using Susurri.Infrastructure.Auth
@implements IAsyncDisposable
<h3>DirectMessages</h3>

<div>
    <input @bind="_recipientUsername" placeholder="Recipient Username" />
    <input @bind="_message" placeholder="Message" />
    <button @onclick="SendMessage">Send</button>
</div>

@code {
    #nullable enable
    private HubConnection? _hubConnection;
    private string? _recipientUsername, _message, _senderUsername;
    private readonly List<string> messages = new();
    
    
    protected override async Task OnInitializedAsync()
    {
        _senderUsername = Options.Value.Issuer;

        // var accessToken = TokenStorage.Get(); 
        
        
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .Build();
        
        _hubConnection.On<string, string, string>("RecieveMessage", async (_senderUsername, _recipientUsername, _message) =>
        {
            messages.Add($"{_senderUsername} to {_recipientUsername}: {_message}");
            await InvokeAsync(StateHasChanged);
            var dbMessage = new ChatMessage() { SenderUsername = _senderUsername, RecipientUsername = _recipientUsername, Content = _message };
            Context.ChatMessages.Add(dbMessage);
            await Context.SaveChangesAsync();
        });
        await LoadMessagesFromDatabase();
        await _hubConnection.StartAsync();
    }

    private async Task LoadMessagesFromDatabase()
    {
        var dbMessages = await Context.ChatMessages.ToListAsync();
        foreach (var msg in dbMessages)
        {
            var encodedMsg = $"{msg.SenderUsername} to {msg.RecipientUsername}: {msg.Content}";
            messages.Add(encodedMsg);
        }
    }
    
    private async Task SendMessage()
    {
        if (IsConnected && !string.IsNullOrEmpty(_senderUsername) && !string.IsNullOrEmpty(_recipientUsername) && !string.IsNullOrEmpty(_message))
        {
            if (_hubConnection is not null)
                await _hubConnection.SendAsync("SendMessage", _senderUsername, _recipientUsername, _message);
            _message = string.Empty;
        }
    }

    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;
    
    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
            await _hubConnection.DisposeAsync();
    }
}